# This is a basic workflow to help you get started with Actions

name: Backend-Deploy

on:
  push:
    branches: 
      - main
    paths :
      - "backend/**"

jobs:

  # This workflow contains a single job called "build"

  deploy: # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      - name: Deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.REMOTE_IP }}
          username: ${{ secrets.REMOTE_SSH_ID }}
          key: ${{ secrets.REMOTE_SSH_KEY }}
          port: ${{ secrets.REMOTE_SSH_PORT }}
          script: |
            whoami
            cd /home
            sudo chown -R ubuntu:ubuntu ubuntu
            cd /home/ubuntu/dockerfile/backend
             echo -e "\
             +------------------------------------+
             |              1. build              |
             +------------------------------------+"
            
            echo ">>>>>> making secret yml..."
            echo "${{ secrets.EC2_SECRET_YML }}" > application-secret.yml
            echo -e "\
             >>>>>> dockerfile run... "
            ls -al
            chmod +x backend_install.sh || exit 1
            chmod +x delete_not_use_image_file.sh || exit 1
            sudo ./backend_install.sh || exit 1
            sudo ./delete_not_use_image_file.sh || exit 1




